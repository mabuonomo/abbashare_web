{"version":3,"sources":["../src/nodePatches.ts"],"names":[],"mappings":"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","file":"nodePatches.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { setWebSocketImpl } from './realtime/WebSocketConnection';\nimport {\n  FirebaseIFrameScriptHolder,\n  FIREBASE_LONGPOLL_COMMAND_CB_NAME,\n  FIREBASE_LONGPOLL_DATA_CB_NAME\n} from './realtime/BrowserPollConnection';\nimport { Client } from 'faye-websocket';\n\nsetWebSocketImpl(Client);\n\n/**\n * @suppress {es5Strict}\n */\n(function() {\n  var version = process['version'];\n  if (\n    version !== 'v0.10.22' &&\n    version !== 'v0.10.23' &&\n    version !== 'v0.10.24'\n  )\n    return;\n  /**\n   * The following duplicates much of `/lib/_stream_writable.js` at\n   * b922b5e90d2c14dd332b95827c2533e083df7e55, applying the fix for\n   * https://github.com/joyent/node/issues/6506. Note that this fix also\n   * needs to be applied to `Duplex.prototype.write()` (in\n   * `/lib/_stream_duplex.js`) as well.\n   */\n  var Writable = require('_stream_writable');\n\n  Writable['prototype']['write'] = function(chunk, encoding, cb) {\n    var state = this['_writableState'];\n    var ret = false;\n\n    if (typeof encoding === 'function') {\n      cb = encoding;\n      encoding = null;\n    }\n\n    if (Buffer['isBuffer'](chunk)) encoding = 'buffer';\n    else if (!encoding) encoding = state['defaultEncoding'];\n\n    if (typeof cb !== 'function') cb = function() {};\n\n    if (state['ended']) writeAfterEnd(this, state, cb);\n    else if (validChunk(this, state, chunk, cb))\n      ret = writeOrBuffer(this, state, chunk, encoding, cb);\n\n    return ret;\n  };\n\n  function writeAfterEnd(stream, state, cb) {\n    var er = new Error('write after end');\n    // TODO: defer error events consistently everywhere, not just the cb\n    stream['emit']('error', er);\n    process['nextTick'](function() {\n      cb(er);\n    });\n  }\n\n  function validChunk(stream, state, chunk, cb) {\n    var valid = true;\n    if (\n      !Buffer['isBuffer'](chunk) &&\n      'string' !== typeof chunk &&\n      chunk !== null &&\n      chunk !== undefined &&\n      !state['objectMode']\n    ) {\n      var er = new TypeError('Invalid non-string/buffer chunk');\n      stream['emit']('error', er);\n      process['nextTick'](function() {\n        cb(er);\n      });\n      valid = false;\n    }\n    return valid;\n  }\n\n  function writeOrBuffer(stream, state, chunk, encoding, cb) {\n    chunk = decodeChunk(state, chunk, encoding);\n    if (Buffer['isBuffer'](chunk)) encoding = 'buffer';\n    var len = state['objectMode'] ? 1 : chunk['length'];\n\n    state['length'] += len;\n\n    var ret = state['length'] < state['highWaterMark'];\n    // we must ensure that previous needDrain will not be reset to false.\n    if (!ret) state['needDrain'] = true;\n\n    if (state['writing'])\n      state['buffer']['push'](new WriteReq(chunk, encoding, cb));\n    else doWrite(stream, state, len, chunk, encoding, cb);\n\n    return ret;\n  }\n\n  function decodeChunk(state, chunk, encoding) {\n    if (\n      !state['objectMode'] &&\n      state['decodeStrings'] !== false &&\n      typeof chunk === 'string'\n    ) {\n      chunk = new Buffer(chunk, encoding);\n    }\n    return chunk;\n  }\n\n  /**\n   * @constructor\n   */\n  function WriteReq(chunk, encoding, cb) {\n    this['chunk'] = chunk;\n    this['encoding'] = encoding;\n    this['callback'] = cb;\n  }\n\n  function doWrite(stream, state, len, chunk, encoding, cb) {\n    state['writelen'] = len;\n    state['writecb'] = cb;\n    state['writing'] = true;\n    state['sync'] = true;\n    stream['_write'](chunk, encoding, state['onwrite']);\n    state['sync'] = false;\n  }\n\n  var Duplex = require('_stream_duplex');\n  Duplex['prototype']['write'] = Writable['prototype']['write'];\n})();\n\n/**\n * @type {?function({url: string, forever: boolean}, function(Error, number, string))}\n */\n(FirebaseIFrameScriptHolder as any).request = null;\n\n/**\n * @param {{url: string, forever: boolean}} req\n * @param {function(string)=} onComplete\n */\n(FirebaseIFrameScriptHolder as any).nodeRestRequest = function(\n  req,\n  onComplete\n) {\n  if (!(FirebaseIFrameScriptHolder as any).request)\n    (FirebaseIFrameScriptHolder as any).request = /** @type {function({url: string, forever: boolean}, function(Error, number, string))} */ require('request');\n\n  (FirebaseIFrameScriptHolder as any).request(req, function(\n    error,\n    response,\n    body\n  ) {\n    if (error) throw 'Rest request for ' + req.url + ' failed.';\n\n    if (onComplete) onComplete(body);\n  });\n};\n\n/**\n * @param {!string} url\n * @param {function()} loadCB\n */\n(<any>FirebaseIFrameScriptHolder.prototype).doNodeLongPoll = function(\n  url,\n  loadCB\n) {\n  var self = this;\n  (FirebaseIFrameScriptHolder as any).nodeRestRequest(\n    { url: url, forever: true },\n    function(body) {\n      self.evalBody(body);\n      loadCB();\n    }\n  );\n};\n\n/**\n * Evaluates the string contents of a jsonp response.\n * @param {!string} body\n */\n(<any>FirebaseIFrameScriptHolder.prototype).evalBody = function(body) {\n  var jsonpCB;\n  //jsonpCB is externed in firebase-extern.js\n  eval(\n    'jsonpCB = function(' +\n      FIREBASE_LONGPOLL_COMMAND_CB_NAME +\n      ', ' +\n      FIREBASE_LONGPOLL_DATA_CB_NAME +\n      ') {' +\n      body +\n      '}'\n  );\n  jsonpCB(this.commandCB, this.onMessageCB);\n};\n"]}