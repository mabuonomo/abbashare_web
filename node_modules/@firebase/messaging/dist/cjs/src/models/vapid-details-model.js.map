{"version":3,"sources":["../src/models/vapid-details-model.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;GAcG;AACH,YAAY,CAAC;;;;;;;;;;;;AAEb,+CAAyC;AACzC,mCAA8B;AAE9B,IAAM,mBAAmB,GAAG,wBAAwB,CAAC;AACrD,IAAM,UAAU,GAAG,CAAC,CAAC;AAErB;IAA+C,qCAAW;IACxD;eACE,kBAAM,iBAAiB,CAAC,MAAM,EAAE,UAAU,CAAC;IAC7C,CAAC;IAED,sBAAW,2BAAM;aAAjB;YACE,MAAM,CAAC,sBAAsB,CAAC;QAChC,CAAC;;;OAAA;IAED;;;OAGG;IACH,uCAAW,GAAX,UAAY,EAAE;QACZ,EAAE,CAAC,iBAAiB,CAAC,mBAAmB,EAAE;YACxC,OAAO,EAAE,SAAS;SACnB,CAAC,CAAC;IACL,CAAC;IAED;;;;;OAKG;IACH,+CAAmB,GAAnB,UAAoB,OAAO;QACzB,EAAE,CAAC,CAAC,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YACxD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,gBAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;QAC3E,CAAC;QAED,MAAM,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,IAAI,CAAC,UAAA,EAAE;YAChC,MAAM,CAAC,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;gBACjC,IAAM,WAAW,GAAG,EAAE,CAAC,WAAW,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC;gBAC1D,IAAM,WAAW,GAAG,WAAW,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;gBACjE,IAAM,YAAY,GAAG,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;gBAC9C,YAAY,CAAC,OAAO,GAAG,UAAA,KAAK;oBAC1B,MAAM,CAAc,KAAK,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC;gBAC3C,CAAC,CAAC;gBAEF,YAAY,CAAC,SAAS,GAAG,UAAA,KAAK;oBAC5B,IAAI,MAAM,GAAgB,KAAK,CAAC,MAAO,CAAC,MAAM,CAAC;oBAC/C,IAAI,QAAQ,GAAG,IAAI,CAAC;oBACpB,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;wBACX,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC;oBAC7B,CAAC;oBACD,OAAO,CAAC,QAAQ,CAAC,CAAC;gBACpB,CAAC,CAAC;YACJ,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;;;;;;OAOG;IACH,4CAAgB,GAAhB,UAAiB,OAAO,EAAE,QAAQ;QAAlC,iBAgCC;QA/BC,EAAE,CAAC,CAAC,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YACxD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,gBAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;QAC3E,CAAC;QAED,EAAE,CAAC,CAAC,OAAO,QAAQ,KAAK,QAAQ,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YAC1D,MAAM,CAAC,OAAO,CAAC,MAAM,CACnB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,gBAAM,CAAC,KAAK,CAAC,aAAa,CAAC,CACtD,CAAC;QACJ,CAAC;QAED,IAAM,OAAO,GAAG;YACd,OAAO,EAAE,OAAO;YAChB,QAAQ,EAAE,QAAQ;SACnB,CAAC;QAEF,MAAM,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,IAAI,CAAC,UAAA,EAAE;YAChC,MAAM,CAAC,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;gBACjC,IAAM,WAAW,GAAG,EAAE,CAAC,WAAW,CAChC,CAAC,mBAAmB,CAAC,EACrB,KAAI,CAAC,sBAAsB,CAC5B,CAAC;gBACF,IAAM,WAAW,GAAG,WAAW,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;gBACjE,IAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;gBACzC,OAAO,CAAC,OAAO,GAAG,UAAA,KAAK;oBACrB,MAAM,CAAc,KAAK,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC;gBAC3C,CAAC,CAAC;gBACF,OAAO,CAAC,SAAS,GAAG,UAAA,KAAK;oBACvB,OAAO,EAAE,CAAC;gBACZ,CAAC,CAAC;YACJ,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;;;;OAKG;IACH,8CAAkB,GAAlB,UAAmB,OAAO;QAA1B,iBA8BC;QA7BC,MAAM,CAAC,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,UAAA,QAAQ;YACpD,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACd,MAAM,KAAI,CAAC,aAAa,CAAC,MAAM,CAAC,gBAAM,CAAC,KAAK,CAAC,sBAAsB,CAAC,CAAC;YACvE,CAAC;YAED,MAAM,CAAC,KAAI,CAAC,YAAY,EAAE,CAAC,IAAI,CAAC,UAAA,EAAE;gBAChC,MAAM,CAAC,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;oBACjC,IAAM,WAAW,GAAG,EAAE,CAAC,WAAW,CAChC,CAAC,mBAAmB,CAAC,EACrB,KAAI,CAAC,sBAAsB,CAC5B,CAAC;oBACF,IAAM,WAAW,GAAG,WAAW,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;oBACjE,IAAM,OAAO,GAAG,WAAW,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;oBAC5C,OAAO,CAAC,OAAO,GAAG,UAAA,KAAK;wBACrB,MAAM,CAAc,KAAK,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC;oBAC3C,CAAC,CAAC;oBACF,OAAO,CAAC,SAAS,GAAG,UAAA,KAAK;wBACvB,EAAE,CAAC,CAAc,KAAK,CAAC,MAAO,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;4BAC5C,MAAM,CACJ,KAAI,CAAC,aAAa,CAAC,MAAM,CAAC,gBAAM,CAAC,KAAK,CAAC,uBAAuB,CAAC,CAChE,CAAC;4BACF,MAAM,CAAC;wBACT,CAAC;wBAED,OAAO,CAAC,QAAQ,CAAC,CAAC;oBACpB,CAAC,CAAC;gBACJ,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IACH,wBAAC;AAAD,CAlIA,AAkIC,CAlI8C,sBAAW,GAkIzD","file":"vapid-details-model.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nimport DBInterface from './db-interface';\nimport Errors from './errors';\n\nconst FCM_VAPID_OBJ_STORE = 'fcm_vapid_object_Store';\nconst DB_VERSION = 1;\n\nexport default class VapidDetailsModel extends DBInterface {\n  constructor() {\n    super(VapidDetailsModel.dbName, DB_VERSION);\n  }\n\n  static get dbName() {\n    return 'fcm_vapid_details_db';\n  }\n\n  /**\n   * @override\n   * @param {IDBDatabase} db\n   */\n  onDBUpgrade(db) {\n    db.createObjectStore(FCM_VAPID_OBJ_STORE, {\n      keyPath: 'swScope'\n    });\n  }\n\n  /**\n   * Given a service worker scope, this method will look up the vapid key\n   * in indexedDB.\n   * @param {string} swScope\n   * @return {Promise<string>} The vapid key associated with that scope.\n   */\n  getVapidFromSWScope(swScope) {\n    if (typeof swScope !== 'string' || swScope.length === 0) {\n      return Promise.reject(this.errorFactory_.create(Errors.codes.BAD_SCOPE));\n    }\n\n    return this.openDatabase().then(db => {\n      return new Promise((resolve, reject) => {\n        const transaction = db.transaction([FCM_VAPID_OBJ_STORE]);\n        const objectStore = transaction.objectStore(FCM_VAPID_OBJ_STORE);\n        const scopeRequest = objectStore.get(swScope);\n        scopeRequest.onerror = event => {\n          reject((<IDBRequest>event.target).error);\n        };\n\n        scopeRequest.onsuccess = event => {\n          let result = (<IDBRequest>event.target).result;\n          let vapidKey = null;\n          if (result) {\n            vapidKey = result.vapidKey;\n          }\n          resolve(vapidKey);\n        };\n      });\n    });\n  }\n\n  /**\n   * Save a vapid key against a swScope for later date.\n   * @param  {string} swScope The service worker scope to be associated with\n   * this push subscription.\n   * @param {string} vapidKey The public vapid key to be associated with\n   * the swScope.\n   * @return {Promise<void>}\n   */\n  saveVapidDetails(swScope, vapidKey) {\n    if (typeof swScope !== 'string' || swScope.length === 0) {\n      return Promise.reject(this.errorFactory_.create(Errors.codes.BAD_SCOPE));\n    }\n\n    if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\n      return Promise.reject(\n        this.errorFactory_.create(Errors.codes.BAD_VAPID_KEY)\n      );\n    }\n\n    const details = {\n      swScope: swScope,\n      vapidKey: vapidKey\n    };\n\n    return this.openDatabase().then(db => {\n      return new Promise((resolve, reject) => {\n        const transaction = db.transaction(\n          [FCM_VAPID_OBJ_STORE],\n          this.TRANSACTION_READ_WRITE\n        );\n        const objectStore = transaction.objectStore(FCM_VAPID_OBJ_STORE);\n        const request = objectStore.put(details);\n        request.onerror = event => {\n          reject((<IDBRequest>event.target).error);\n        };\n        request.onsuccess = event => {\n          resolve();\n        };\n      });\n    });\n  }\n\n  /**\n   * This method deletes details of the current FCM VAPID key for a SW scope.\n   * @param {string} swScope Scope to be deleted\n   * @return {Promise<string>} Resolves once the scope / vapid details have been\n   * deleted and returns the deleted vapid key.\n   */\n  deleteVapidDetails(swScope) {\n    return this.getVapidFromSWScope(swScope).then(vapidKey => {\n      if (!vapidKey) {\n        throw this.errorFactory_.create(Errors.codes.DELETE_SCOPE_NOT_FOUND);\n      }\n\n      return this.openDatabase().then(db => {\n        return new Promise((resolve, reject) => {\n          const transaction = db.transaction(\n            [FCM_VAPID_OBJ_STORE],\n            this.TRANSACTION_READ_WRITE\n          );\n          const objectStore = transaction.objectStore(FCM_VAPID_OBJ_STORE);\n          const request = objectStore.delete(swScope);\n          request.onerror = event => {\n            reject((<IDBRequest>event.target).error);\n          };\n          request.onsuccess = event => {\n            if ((<IDBRequest>event.target).result === 0) {\n              reject(\n                this.errorFactory_.create(Errors.codes.FAILED_DELETE_VAPID_KEY)\n              );\n              return;\n            }\n\n            resolve(vapidKey);\n          };\n        });\n      });\n    });\n  }\n}\n"]}